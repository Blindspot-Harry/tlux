{% extends "base.html" %}
{% block title %}⚡ Painel — T-Lux{% endblock %}

{% block content %}
<div class="container dashboard-container">

  <!-- Aviso de e-mail não verificado -->
  {% if not session.get("email_verified", False) %}
    <div class="alert alert-warning alert-dismissible fade show shadow-sm mb-3" role="alert">
      ⚠️ Sua conta ainda não foi verificada. 
      <a href="{{ url_for('resend_verification') }}" class="alert-link">Reenviar e-mail de verificação</a>
      para ativar todos os recursos.
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
    </div>
  {% endif %}

  <!-- Cabeçalho -->
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="card card-tlux p-4 shadow-sm">
        <h3 class="text-gold mb-2">👋 Bem-vindo, {{ user["first_name"] or user["email"] }}</h3>
        <p class="small-muted mb-1">📧 Conta: <strong>{{ user["email"] }}</strong></p>

        {% if user["access_expiry"] %}
          {% if licenca_ativa %}
            <p class="small-muted mb-1">🕒 Licença ativa até:
              <span class="badge bg-success">{{ user["access_expiry"] }}</span>
            </p>
          {% else %}
            <p class="small-muted mb-1">🕒 Licença expirada em:
              <span class="badge bg-danger">{{ user["access_expiry"] }}</span>
            </p>
          {% endif %}
        {% else %}
          <p class="small-muted mb-1">🕒 Nenhuma licença ativa</p>
        {% endif %}

        <p class="small-muted">💰 Saldo disponível: 
          <span class="fw-bold text-gold">{{ saldo or 0 }} USD</span>
        </p>

        <div class="mt-3 d-flex flex-wrap gap-2">
          <a class="btn btn-brighton" href="{{ url_for('verificar_serial') }}">🔎 Verificar Serial / IMEI</a>
          <a class="btn btn-outline-gold" href="{{ url_for('choose_package') }}">💳 Comprar Pacote</a>
          <a class="btn btn-outline-gold" href="{{ url_for('obter_tecnico') }}">👨‍💻 Suporte Técnico</a>
          <a class="btn btn-outline-gold" href="{{ url_for('services') }}">🔑 Serviços</a>
          <a class="btn btn-outline-gold" href="{{ url_for('orders') }}">📦 Meus Pedidos</a>
          <a class="btn btn-outline-gold" href="{{ url_for('obter_tecnico') }}">⚡ Quero ser Técnico T-Lux</a>
        </div>
      </div>
    </div>

    <!-- Atalhos rápidos -->
    <div class="col-md-4">
      <div class="card card-tlux p-4 shadow-sm h-100">
        <h5 class="text-gold mb-3">⚡ Atalhos Rápidos</h5>
        <div class="d-grid gap-2">
          <a class="btn btn-brighton" href="{{ url_for('verificar_serial') }}">📱 Detectar Modelo / IMEI</a>
          <a class="btn btn-outline-gold" href="{{ url_for('choose_package') }}">💰 Comprar Pacote</a>
          <a class="btn btn-outline-gold" href="{{ url_for('obter_tecnico') }}">🛠️ Acesso Técnico</a>
          <a class="btn btn-outline-gold" href="{{ url_for('services') }}">🔑 Serviços</a>
          <a class="btn btn-outline-gold" href="{{ url_for('orders') }}">📦 Meus Pedidos</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Área principal -->
  <div class="row">
    <!-- Desbloqueio rápido -->
    <div class="col-lg-6 mb-4">
      <div class="card card-tlux p-4 h-100 shadow-sm">
        <h4 class="text-gold mb-3">🔓 Desbloqueio Rápido</h4>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mb-2">
              {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <form action="{{ url_for('verificar_serial') }}" method="POST">
          <div class="mb-3">
            <label for="serial" class="form-label">📱 Número de Série / IMEI</label>
            <input id="serial" type="text" name="serial" class="form-control" 
                   placeholder="Ex: 35XXXXXXXXXXXXX" required>
          </div>

          <div class="mb-3">
            <label for="modelo" class="form-label">📲 Modelo (opcional)</label>
            <select id="modelo" name="modelo" class="form-select">
              <option value="">— Detectar automaticamente —</option>
              {% if modelos %}
                {% for modelo, preco in modelos.items() %}
                  <option value="{{ modelo }}">{{ modelo }} — {{ preco }} USD</option>
                {% endfor %}
              {% endif %}
            </select>
          </div>

          <button type="submit" class="btn btn-brighton w-100">🚀 Detectar / Prosseguir</button>
        </form>
      </div>
    </div>

    <!-- Histórico e transações -->
    <div class="col-lg-6 mb-4">
      <!-- Histórico de desbloqueios -->
      <div class="card card-tlux p-4 mb-3 shadow-sm">
        <h5 class="text-gold mb-3">📜 Histórico de Desbloqueios</h5>
        {% if desbloqueios %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead class="table-dark">
                <tr>
                  <th>📅 Data</th>
                  <th>📱 Modelo</th>
                  <th>🔑 IMEI</th>
                  <th>⚙️ Status</th>
                </tr>
              </thead>
              <tbody>
                {% for d in desbloqueios %}
                  <tr>
                    <td class="small-muted">{{ d["created_at"] }}</td>
                    <td>{{ d["modelo"] }}</td>
                    <td>{{ d["imei"] or d["serial"] }}</td>
                    <td>
                      {% if d["status"] in ['success','successful'] %}
                        <span class="badge bg-success">✅ Sucesso</span>
                      {% elif d["status"] == "pending" %}
                        <span class="badge bg-warning text-dark">⏳ Pendente</span>
                      {% else %}
                        <span class="badge bg-danger">❌ Falhou</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="small-muted">ℹ️ Nenhum desbloqueio ainda.</p>
        {% endif %}
      </div>

      <!-- Transações recentes -->
      <div class="card card-tlux p-4 shadow-sm">
        <h5 class="text-gold mb-3">💳 Transações Recentes</h5>
        {% if transacoes %}
          <ul class="list-group list-group-flush">
            {% for tx in transacoes %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>📦 {{ tx["purpose"]|capitalize }}</strong>
                  <div class="small-muted">
                    {% if tx["modelo"] %}📱 Modelo: {{ tx["modelo"] }}{% endif %}
                    {% if tx["pacote"] %}🎁 Pacote: {{ tx["pacote"] }}{% endif %}
                  </div>
                </div>
                <div class="text-end">
                  <span class="badge
                    {% if tx["status"] in ['success','successful','license_issued'] %}bg-success
                    {% elif tx["status"] == 'pending' %}bg-warning text-dark
                    {% else %}bg-danger{% endif %}">
                    {{ tx["status"] }}
                  </span>
                  <div class="small-muted">📅 {{ tx["created_at"] }}</div>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="small-muted">ℹ️ Nenhuma transação encontrada.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
