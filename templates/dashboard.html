{% extends "base.html" %}
{% block title %}⚡ Dashboard — T-Lux{% endblock %}

{% block content %}
<div class="container dashboard-container my-4">

  <!-- 🟡 Aviso de e-mail não verificado -->
  {% if not session.get("email_verified", False) %}
  <div class="alert alert-warning alert-dismissible fade show shadow-sm mb-3" role="alert">
    ⚠️ Your account has not been verified yet.
    <a href="{{ url_for('resend_verification') }}" class="alert-link">Resend verification email</a> to activate all features.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endif %}

  <!-- 👤 Cabeçalho principal -->
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="card card-tlux p-4 shadow-sm">
        <h3 class="text-gold mb-2">👋 Welcome, {{ user["first_name"] or user["email"] }}</h3>
        <p class="small-muted mb-1">📧 Account: <strong>{{ user["email"] }}</strong></p>

        {% if user["access_expiry"] %}
          {% if user["access_expiry"].startswith("2099") %}
            <p class="small-muted mb-1">
              ♾️ <span class="badge bg-gold text-dark fw-semibold">Lifetime License — Unlimited Access</span>
            </p>
          {% elif licenca_ativa %}
            <p class="small-muted mb-1">
              🕒 License active until:
              <span class="badge bg-success">{{ user["access_expiry"] }}</span>
            </p>
          {% else %}
            <p class="small-muted mb-1">
              ❌ License expired on:
              <span class="badge bg-danger">{{ user["access_expiry"] }}</span>
            </p>
          {% endif %}
        {% else %}
          <p class="small-muted mb-1 text-warning">⚠️ No active license. Please activate your package.</p>
        {% endif %}

        <p class="small-muted">💰 Available Balance:
          <span class="fw-bold text-gold">{{ saldo or 0 }} USD</span>
        </p>

        <!-- 🔘 Ações principais -->
        <div class="mt-3 d-flex flex-wrap gap-2">
          <a class="btn btn-brighton" href="{{ url_for('verificar_serial') }}">🔎 Check Serial / IMEI</a>
          <a class="btn btn-outline-gold" href="{{ url_for('choose_package') }}">💳 Buy / Renew Package</a>
          <a class="btn btn-outline-gold" href="{{ url_for('obter_tecnico') }}">👨‍💻 Technical Support</a>
          <a class="btn btn-outline-gold" href="{{ url_for('services') }}">🔑 Services</a>
          <a class="btn btn-outline-gold" href="{{ url_for('orders') }}">📦 My Orders</a>
        </div>
      </div>
    </div>

    <!-- ⚡ Atalhos rápidos -->
    <div class="col-md-4">
      <div class="card card-tlux p-4 shadow-sm h-100">
        <h5 class="text-gold mb-3">⚡ Quick Shortcuts</h5>
        <div class="d-grid gap-2">
          <a class="btn btn-brighton" href="{{ url_for('verificar_serial') }}">📱 Detect Model / IMEI</a>
          <a class="btn btn-outline-gold" href="{{ url_for('choose_package') }}">💰 Renew Access</a>
          <a class="btn btn-outline-gold" href="{{ url_for('services') }}">🔑 Services</a>
          <a class="btn btn-outline-gold" href="{{ url_for('orders') }}">📦 My Orders</a>
        </div>
      </div>
    </div>
  </div>

  <!-- 🔧 Área principal -->
  <div class="row">

    <!-- Desbloqueio rápido -->
    <div class="col-lg-6 mb-4">
      <div class="card card-tlux p-4 h-100 shadow-sm">
        <h4 class="text-gold mb-3">🔓 Quick Unlock</h4>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mb-2">
              {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <form action="{{ url_for('verificar_serial') }}" method="POST">
          <div class="mb-3">
            <label for="serial" class="form-label">📱 Serial / IMEI Number</label>
            <input id="serial" type="text" name="serial" class="form-control" placeholder="35XXXXXXXXXXXXX" required>
          </div>

          <div class="mb-3">
            <label for="modelo" class="form-label">📲 Model (optional)</label>
            <select id="modelo" name="modelo" class="form-select">
              <option value="">— Detect automatically —</option>
              {% if modelos %}
                {% for modelo, preco in modelos.items() %}
                  <option value="{{ modelo }}">{{ modelo }} — {{ preco }} USD</option>
                {% endfor %}
              {% endif %}
            </select>
          </div>

          <button type="submit" class="btn btn-brighton w-100">🚀 Detect / Proceed</button>
        </form>
      </div>
    </div>

    <!-- Histórico / transações -->
    <div class="col-lg-6 mb-4">

      <!-- Histórico de desbloqueios -->
      <div class="card card-tlux p-4 mb-3 shadow-sm">
        <h5 class="text-gold mb-3">📜 Unlock History</h5>
        {% if desbloqueios %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead class="table-dark">
                <tr>
                  <th>📅 Date</th>
                  <th>📱 Model</th>
                  <th>🔑 IMEI</th>
                  <th>⚙️ Status</th>
                </tr>
              </thead>
              <tbody>
                {% for d in desbloqueios %}
                  <tr>
                    <td class="small-muted">{{ d["created_at"] }}</td>
                    <td>{{ d["modelo"] }}</td>
                    <td>{{ d["imei"] or d["serial"] }}</td>
                    <td>
                      {% if d["status"] in ['success','successful'] %}
                        <span class="badge bg-success">✅ Success</span>
                      {% elif d["status"] == "pending" %}
                        <span class="badge bg-warning text-dark">⏳ Pending</span>
                      {% else %}
                        <span class="badge bg-danger">❌ Failed</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="small-muted">ℹ️ No unlocks yet.</p>
        {% endif %}
      </div>

      <!-- Transações recentes -->
      <div class="card card-tlux p-4 shadow-sm">
        <h5 class="text-gold mb-3">💳 Recent Transactions</h5>
        {% if transacoes %}
          <ul class="list-group list-group-flush">
            {% for tx in transacoes %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>📦 {{ tx["purpose"]|capitalize }}</strong>
                  <div class="small-muted">
                    {% if tx["modelo"] %}📱 Model: {{ tx["modelo"] }}{% endif %}
                    {% if tx["pacote"] %}<br>🎁 Package: {{ tx["pacote"] }}{% endif %}
                  </div>
                </div>
                <div class="text-end">
                  <span class="badge
                    {% if tx["status"] in ['success','successful','license_issued'] %}bg-success
                    {% elif tx["status"] == 'pending' %}bg-warning text-dark
                    {% else %}bg-danger{% endif %}">
                    {{ tx["status"].capitalize() }}
                  </span>
                  <div class="small-muted">📅 {{ tx["created_at"] }}</div>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="small-muted">ℹ️ No transactions found.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<style>
  .text-gold { color: #d4af37; }
  .bg-gold { background-color: #d4af37 !important; }
  .btn-brighton {
    background-color: #0d6efd;
    color: #fff;
    font-weight: 600;
    border: none;
    transition: 0.3s;
  }
  .btn-brighton:hover { background-color: #084298; color: #fff; }
  .btn-outline-gold {
    border: 1px solid #d4af37;
    color: #d4af37;
    font-weight: 600;
  }
  .btn-outline-gold:hover {
    background-color: #d4af37;
    color: #fff;
  }
  .small-muted {
    font-size: 0.9rem;
    color: #777;
  }
</style>
{% endblock %}
