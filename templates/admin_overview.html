{% extends "base.html" %}
{% block title %}ğŸ“Š System Overview â€” T-Lux{% endblock %}

{% block content %}
<div class="container my-4">

  <!-- ===== HEADER ===== -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-gold fw-bold">ğŸ“Š System Overview â€” T-Lux Admin</h2>
    <a href="{{ url_for('admin') }}" class="btn btn-outline-light">â† Back to Dashboard</a>
  </div>

  <!-- ===== GLOBAL STATS ===== -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card card-tlux text-center p-3 shadow-sm">
        <h1>ğŸ‘¥</h1><h3 class="fw-bold">{{ total_users or 0 }}</h3>
        <p class="small-muted">Total Users</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-tlux text-center p-3 shadow-sm">
        <h1>ğŸ§‘â€ğŸ”§</h1><h3 class="fw-bold">{{ total_techs or 0 }}</h3>
        <p class="small-muted">Technicians</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-tlux text-center p-3 shadow-sm">
        <h1>ğŸ’³</h1><h3 class="fw-bold">${{ "%.2f"|format(total_revenue or 0) }}</h3>
        <p class="small-muted">Total Revenue (USD)</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-tlux text-center p-3 shadow-sm">
        <h1>ğŸ§¾</h1><h3 class="fw-bold">{{ total_licenses or 0 }}</h3>
        <p class="small-muted">Licenses Issued</p>
      </div>
    </div>
  </div>

  <!-- ===== MODULE STATUS ===== -->
  <div class="card card-tlux p-4 mb-5 shadow-sm">
    <h5 class="text-gold mb-3">ğŸ§  System Modules Status</h5>
    <table class="table table-sm align-middle">
      <thead class="table-light">
        <tr><th>Module</th><th>Status</th><th>Details</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>Stripe API</td>
          <td>
            {% if stripe_ok %}<span class="badge bg-success">âœ… Active</span>
            {% else %}<span class="badge bg-danger">âŒ Not Configured</span>{% endif %}
          </td>
          <td>Public key: {{ stripe_public or 'N/A' }}</td>
        </tr>
        <tr>
          <td>iRemoval API</td>
          <td>
            {% if iremoval_ok %}<span class="badge bg-success">âœ… Connected</span>
            {% else %}<span class="badge bg-danger">âŒ Not Connected</span>{% endif %}
          </td>
          <td>User: {{ iremoval_user or 'N/A' }}</td>
        </tr>
        <tr>
          <td>SMTP Mail</td>
          <td>
            {% if mail_ok %}<span class="badge bg-success">âœ… Active</span>
            {% else %}<span class="badge bg-danger">âŒ Offline</span>{% endif %}
          </td>
          <td>Sender: {{ mail_sender or 'N/A' }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ===== PERFORMANCE CHART ===== -->
  <div class="card card-tlux p-4 mb-5 shadow-sm">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="text-gold mb-0">ğŸ“ˆ Performance Chart (7 Days)</h5>
      <small class="text-muted">Revenue vs Transactions</small>
    </div>
    <canvas id="overviewChart" height="100"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  async function loadOverviewChart() {
    const res = await fetch("/admin/chart_data");
    const data = await res.json();
    const labels = data.map(d => d.day).reverse();
    const revenue = data.map(d => d.total_revenue).reverse();
    const txs = data.map(d => d.total_transactions).reverse();

    new Chart(document.getElementById("overviewChart"), {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label: "Revenue ($)", data: revenue, backgroundColor: "rgba(255,215,0,0.6)" },
          { label: "Transactions", data: txs, backgroundColor: "rgba(0,123,255,0.4)" }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, title: { display: true, text: "Amount / Count" } },
          x: { title: { display: true, text: "Date" } }
        },
        plugins: {
          legend: { position: "top" },
          tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.raw}` } }
        }
      }
    });
  }
  loadOverviewChart();
  </script>

  <!-- ===== QUICK ACTIONS ===== -->
  <div class="card card-tlux p-4 shadow-sm">
    <h5 class="text-gold mb-3">âš¡ Quick Actions</h5>
    <div class="d-flex flex-wrap gap-3 justify-content-center">
      <a href="{{ url_for('admin_transactions') }}" class="btn btn-outline-primary px-4">ğŸ’³ View Transactions</a>
      <a href="{{ url_for('admin_unlocks') }}" class="btn btn-outline-success px-4">ğŸ”“ Manage Unlocks</a>
      <a href="{{ url_for('update_services') }}" class="btn btn-outline-warning px-4">ğŸ” Update Services</a>
      <a href="{{ url_for('settings') }}" class="btn btn-outline-dark px-4">âš™ï¸ System Settings</a>
      <a href="{{ url_for('admin_logs') }}" class="btn btn-outline-secondary px-4">ğŸ“‹ View Logs</a>
    </div>
  </div>
</div>
{% endblock %}
