{% extends "base.html" %}
{% block title %}⚙️ Admin Dashboard — T-Lux{% endblock %}

{% block content %}
<div class="container admin-dashboard my-4">

  <!-- ===== ADMIN CONTROL BAR ===== -->
  <div class="card card-tlux p-3 mb-4 shadow-sm">
    <div class="d-flex flex-wrap justify-content-center gap-2">
      <a href="{{ url_for('admin_inbox') }}" class="btn btn-outline-light position-relative">
        💬 Inbox
        {% if unread_count and unread_count > 0 %}
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark">
            {{ unread_count }}
          </span>
        {% endif %}
      </a>

      <a href="{{ url_for('admin_overview') }}" class="btn btn-outline-info">📊 Overview</a>
      <a href="{{ url_for('admin_transactions') }}" class="btn btn-outline-primary">💳 Transactions</a>
      <a href="{{ url_for('admin_unlocks') }}" class="btn btn-outline-success">🔓 Unlocks</a>
      <a href="{{ url_for('admin_home') }}" class="btn btn-outline-warning">🧑‍💻 Users</a>
      <a href="{{ url_for('admin_licenses') }}" class="btn btn-outline-secondary">🧾 Licenses</a>
      <a href="{{ url_for('admin_balance') }}" class="btn btn-outline-light">💰 Balance</a>
      <a href="{{ url_for('update_services') }}" class="btn btn-outline-success">🔁 Update Services</a>
      <a href="{{ url_for('admin_logs') }}" class="btn btn-outline-secondary">📋 Logs</a>
      <a href="{{ url_for('settings') }}" class="btn btn-outline-dark">⚙️ Settings</a>
    </div>
  </div>

  <!-- ===== HEADER ===== -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-gold fw-bold">⚙️ T-Lux Admin Dashboard</h2>
    <a href="{{ url_for('admin_overview') }}" class="btn btn-tlux btn-sm shadow-sm">📊 System Overview</a>
  </div>

  <!-- ===== FINANCIAL CHART ===== -->
  <div class="card card-tlux p-4 mb-5 shadow-sm">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="text-gold mb-0">💹 Financial Overview (USD)</h5>
      <small class="text-muted">Last 14 days</small>
    </div>
    <canvas id="revenueChart" height="100"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  async function loadChart() {
    const res = await fetch("/admin/chart_data");
    const data = await res.json();
    const labels = data.map(d => d.day).reverse();
    const revenue = data.map(d => d.total_revenue).reverse();
    const cost = data.map(d => d.total_cost).reverse();
    const profit = data.map(d => d.profit).reverse();

    new Chart(document.getElementById("revenueChart"), {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "Revenue ($)", data: revenue, borderColor: "#FFD700", backgroundColor: "rgba(255,215,0,0.25)", tension: 0.3, fill: true },
          { label: "Supplier Cost ($)", data: cost, borderColor: "#007BFF", backgroundColor: "rgba(0,123,255,0.15)", tension: 0.3, fill: true },
          { label: "Profit ($)", data: profit, borderColor: "#28A745", backgroundColor: "rgba(40,167,69,0.2)", tension: 0.3, fill: true }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, title: { display: true, text: "Amount (USD)" } },
          x: { title: { display: true, text: "Date" } }
        },
        plugins: {
          legend: { position: "top" },
          tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: $${parseFloat(ctx.raw).toFixed(2)}` } }
        }
      }
    });
  }
  loadChart();
  </script>

  <!-- ===== MAIN STATS ===== -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card card-tlux text-center p-3 shadow-sm">
        <h1>👥</h1><h3 class="fw-bold">{{ total_users or users|length }}</h3>
        <p class="small-muted">Users Registered</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-tlux text-center p-3 shadow-sm">
        <h1>💳</h1><h3 class="fw-bold">{{ total_transactions or tx|length }}</h3>
        <p class="small-muted">Transactions</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-tlux text-center p-3 shadow-sm">
        <h1>🔓</h1><h3 class="fw-bold">{{ total_unlocks or 0 }}</h3>
        <p class="small-muted">Unlocks Executed</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-tlux text-center p-3 shadow-sm">
        <h1>💰</h1><h3 class="fw-bold">${{ "%.2f"|format(receita_total or 0) }}</h3>
        <p class="small-muted">Total Revenue (USD)</p>
      </div>
    </div>
  </div>

  <!-- ===== PENDING UNLOCKS ===== -->
  <div class="card card-tlux p-3 mb-5 shadow-sm">
    <h5 class="text-gold mb-3">⚠️ Pending Unlock Requests</h5>
    {% if pendentes %}
      <div class="table-responsive">
        <table class="table table-hover table-sm align-middle">
          <thead class="table-light">
            <tr><th>ID</th><th>User</th><th>Model</th><th>IMEI</th><th>Status</th><th>Action</th></tr>
          </thead>
          <tbody>
            {% for u in pendentes %}
              <tr>
                <td>#{{ u.id }}</td><td>{{ u.user_email }}</td><td>{{ u.modelo or "N/A" }}</td>
                <td>{{ u.imei or "—" }}</td>
                <td><span class="badge bg-warning text-dark">⏳ Pending</span></td>
                <td><a href="{{ url_for('admin_unlocks') }}" class="btn btn-sm btn-tlux">Process</a></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="small-muted">No pending unlocks.</p>
    {% endif %}
  </div>

  <!-- ===== USER MANAGEMENT ===== -->
  <div class="card card-tlux p-3 mb-5 shadow-sm">
    <h5 class="text-gold mb-3">🧑‍💻 User Management</h5>
    {% if users %}
      <div class="table-responsive">
        <table class="table table-striped table-sm align-middle">
          <thead class="table-light">
            <tr><th>Email</th><th>Role</th><th>Balance (USD)</th><th>Approved</th><th>Blocked</th><th>Actions</th></tr>
          </thead>
          <tbody>
            {% for u in users %}
              <tr class="{{ 'table-danger' if u.blocked else '' }}">
                <td>{{ u.email }}</td>
                <td>
                  <form method="post" action="{{ url_for('admin_change_role', user_id=u.id) }}" class="d-flex gap-2">
                    <select name="role" class="form-select form-select-sm">
                      <option value="user" {{ 'selected' if u.role == 'user' }}>User</option>
                      <option value="tech" {{ 'selected' if u.role == 'tech' }}>Technician</option>
                      <option value="admin" {{ 'selected' if u.role == 'admin' }}>Admin</option>
                    </select>
                    <button class="btn btn-sm btn-outline-primary">💾</button>
                  </form>
                </td>
                <td>${{ '%.2f'|format(u.balance or 0) }}</td>
                <td>{% if u.approved %}✅{% else %}
                  <form method="post" action="{{ url_for('admin_approve_user', user_id=u.id) }}">
                    <button class="btn btn-sm btn-outline-success">Approve</button>
                  </form>{% endif %}
                </td>
                <td>{{ "🚫" if u.blocked else "✅" }}</td>
                <td class="d-flex flex-wrap gap-2">
                  {% if not u.blocked %}
                    <form method="post" action="{{ url_for('admin_block_user', user_id=u.id) }}">
                      <button class="btn btn-sm btn-outline-danger">Block</button>
                    </form>
                  {% else %}
                    <form method="post" action="{{ url_for('admin_unblock_user', user_id=u.id) }}">
                      <button class="btn btn-sm btn-outline-warning">Unblock</button>
                    </form>
                  {% endif %}
                  <form method="post" action="{{ url_for('admin_adjust_balance', user_id=u.id) }}" class="d-flex gap-1">
                    <input type="number" step="0.01" name="amount" placeholder="$" class="form-control form-control-sm w-50" required>
                    <input type="hidden" name="reason" value="Manual adjustment">
                    <button class="btn btn-sm btn-outline-success">➕</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="small-muted">No users found.</p>
    {% endif %}
  </div>

  <!-- ===== SUPPLIER TRANSACTIONS ===== -->
  <div class="card card-tlux p-3 mb-5 shadow-sm">
    <h5 class="text-gold mb-3">📦 Recent Unlock Transactions (Supplier Prices)</h5>
    {% if tx %}
      <div class="table-responsive">
        <table class="table table-striped table-sm align-middle">
          <thead class="table-light">
            <tr><th>ID</th><th>User ID</th><th>Model</th><th>IMEI</th><th>Supplier Price ($)</th><th>Status</th><th>Date</th></tr>
          </thead>
          <tbody>
            {% for t in tx %}
              <tr>
                <td>#{{ t.id }}</td><td>{{ t.user_id }}</td><td>{{ t.modelo or 'N/A' }}</td>
                <td>{{ t.imei or '—' }}</td>
                <td>${{ '%.2f'|format(t.preco_fornecedor or 0) }}</td>
                <td>
                  {% if t.status in ['success','successful'] %}
                    <span class="badge bg-success">✅ Success</span>
                  {% elif t.status == 'pending' %}
                    <span class="badge bg-warning text-dark">⏳ Pending</span>
                  {% else %}
                    <span class="badge bg-danger">❌ Failed</span>
                  {% endif %}
                </td>
                <td class="small-muted">{{ t.created_at }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="small-muted">No transactions found.</p>
    {% endif %}
  </div>

  <!-- ===== QUICK LOGS ===== -->
  <div class="card card-tlux p-3 shadow-sm">
    <h5 class="text-gold mb-3">📋 Latest Activity Logs</h5>
    {% if ultimos_logs %}
      <div class="table-responsive">
        <table class="table table-sm">
          <thead><tr><th>Date</th><th>User</th><th>Action</th></tr></thead>
          <tbody>
            {% for log in ultimos_logs %}
              <tr><td class="small-muted">{{ log.data_hora }}</td><td>{{ log.user_email or "—" }}</td><td>{{ log.acao or log.status }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="small-muted">No recent logs.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
