{% extends "base.html" %}
{% block title %}{{ _("Enter Verification Code ‚Äî T-Lux") }}{% endblock %}
{% block content %}

<div class="container my-5 text-center animate__animated animate__fadeInUp">
  <div class="card shadow-lg border-0 mx-auto rounded-4 p-4" style="max-width:480px;background:#fff;">
    
    <!-- Header -->
    <h4 class="fw-bold gold-text mb-2">üì© {{ _("Check Your Email") }}</h4>
    <p class="text-secondary mb-4">
      {{ _("We‚Äôve sent a 6-digit verification code to") }} <strong>{{ masked_email }}</strong><br>
      {{ _("This code is valid for 30 seconds.") }}
    </p>

    <!-- OTP Form -->
    <form method="POST" action="{{ url_for('verify_step2') }}" id="otpForm">
      <div class="d-flex justify-content-center gap-2 mb-3">
        {% for i in range(6) %}
        <input type="text" maxlength="1" inputmode="numeric" name="digit{{ i }}" 
               class="otp-input text-center fs-3 fw-bold" required>
        {% endfor %}
      </div>
      <input type="hidden" name="email" value="{{ email }}">

      <button id="verifyBtn" type="submit" class="btn btn-tlux w-100 fw-bold py-2 mt-2">
        ‚úÖ {{ _("Verify Code") }}
      </button>

      <p class="mt-3 small text-muted">
        ‚è≥ {{ _("Code expires in") }} <span id="countdown" class="fw-semibold text-primary">00:30</span>
      </p>

      <p id="expiredMsg" class="text-danger small fw-semibold mt-2" style="display:none;">
        ‚ö†Ô∏è {{ _("Code expired. Please request a new one.") }}
      </p>
    </form>

    <!-- Resend -->
    <hr class="my-4">
    <form action="{{ url_for('resend_verification_code_route') }}" method="POST" 
          class="d-flex justify-content-center gap-2 flex-wrap">
      <input type="email" name="email" value="{{ email }}" hidden>
      <button id="resendBtn" type="submit" class="btn btn-outline-primary fw-bold px-3 rounded-3">
        üîÅ {{ _("Resend Code") }}
      </button>
    </form>

    <!-- Loading spinner (hidden by default) -->
    <div id="loadingSpinner" class="mt-4 text-center" style="display:none;">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2 small text-primary fw-semibold">üîÑ {{ _("Validating code...") }}</p>
    </div>

  </div>
</div>

<style>
  body { background:#f7f8fa; }
  .gold-text { color:#d4af37; }
  .otp-input {
    width:50px; height:55px;
    border:2px solid #d4af37;
    border-radius:10px;
    outline:none;
    transition:0.2s;
    color:#0d6efd;
  }
  .otp-input:focus {
    border-color:#0d6efd;
    box-shadow:0 0 8px rgba(13,110,253,0.4);
  }
  .btn-tlux {
    background-color:#d4af37;
    border:none;
    color:#fff;
    font-weight:700;
    transition:0.3s;
  }
  .btn-tlux:hover { background-color:#0d6efd; color:#fff; }
</style>

<script>
  // Move focus automatically between inputs
  const inputs = document.querySelectorAll(".otp-input");
  inputs.forEach((input, idx) => {
    input.addEventListener("input", () => {
      if (input.value && idx < inputs.length - 1) inputs[idx + 1].focus();
    });
  });

  // Countdown 30s
  let remaining = 30;
  const countdown = document.getElementById("countdown");
  const expiredMsg = document.getElementById("expiredMsg");
  const verifyBtn = document.getElementById("verifyBtn");

  const timer = setInterval(() => {
    if (remaining <= 0) {
      clearInterval(timer);
      countdown.textContent = "00:00";
      verifyBtn.disabled = true;
      verifyBtn.classList.add("disabled");
      expiredMsg.style.display = "block";
      return;
    }
    remaining--;
    const sec = String(remaining).padStart(2, "0");
    countdown.textContent = `00:${sec}`;
  }, 1000);

  // Spinner quando o formul√°rio √© enviado
  const otpForm = document.getElementById("otpForm");
  const loadingSpinner = document.getElementById("loadingSpinner");
  otpForm.addEventListener("submit", () => {
    loadingSpinner.style.display = "block";
  });
</script>

{% endblock %}

